<!DOCTYPE html>
<html>
<head>
  <base target="_top">
</head>
<body>
  <h1>스왑 및 스테이킹</h1>
  <form id="swapForm">
    <label for="player">플레이어 선택:</label>
    <select id="player" name="player">
      <option value="A">Player A</option>
      <option value="B">Player B</option>
      <option value="C">Player C</option>
      <option value="D">Player D</option>
      <option value="E">Player E</option>
      <option value="F">Player F</option>
      <option value="G">Player G</option>
      <option value="H">Player H</option>
    </select>
    <br>
     <br>

    <label for="action">액션 선택:</label>
    <select id="action" name="action">
      <option value="swap">스왑</option>
      <option value="stake">스테이킹</option>
    </select>
    <br>
     <br>

    <div id="swapFields">
       <label for="swapType">스왑 유형 선택:</label>
      <select id="swapType" name="swapType">
        <option value="ls">L-S</option>
        <option value="sl">S-L</option>
      </select>
      <br>
       <br>
      
      <label for="swapAmount">스왑 수량:</label>
      <input type="number" id="swapAmount" name="swapAmount" min="1">
      <br>
       <br>
    </div>
    
    <div id="stakeFields">
      <label for="stakeType">스테이킹 유형 선택:</label>
      <select id="stakeType" name="stakeType">
        <option value="stake">스테이킹</option>
        <option value="unstake">언스테이킹</option>
      </select>
      <br>
       <br>
      <label for="lpAmount">예치 수량:</label>
      <input type="number" id="lpAmount" name="lpAmount" min="1">
      <br>
       <br>
    </div>
    
   <!-- 버튼들 -->
<button type="button" id="calculateButton" onclick="calculateActionAmount()">계산</button>
<button type="button" id="executeButton" onclick="executeAction()">실행</button>

<!-- 실행 결과 및 예상 스왑량 출력 영역 -->
<div id="expectedOutput"></div>
 <br>
  <br>
<div id="resultOutput"></div>

<script>
  function updateFields(action) {
  var swapFields = document.getElementById("swapFields");
  var stakeFields = document.getElementById("stakeFields");
  
  if (action === "swap") {
    swapFields.style.display = "block";
    stakeFields.style.display = "none";
  } else if (action === "stake") {
    swapFields.style.display = "none";
    stakeFields.style.display = "block";
  }
}

  // 예상 스왑량 계산 함수
function calculateActionAmount() {
  var action = document.getElementById("action").value;
  var swapType = document.getElementById("swapType").value;
  var swapAmount = parseInt(document.getElementById("swapAmount").value);
  var lpAmount = parseInt(document.getElementById("lpAmount").value);

  console.log(action, swapType, swapAmount, lpAmount);

  google.script.run.withSuccessHandler(function(data) {
    updateExpectedSwapAmount(data, action, swapType, swapAmount, lpAmount);
  }).getSheetData(); // 시트 데이터 로딩
}

// 시트 데이터를 받아온 후 예상 스왑량 계산 함수 실행
function updateExpectedSwapAmount(data, action, swapType, swapAmount, lpAmount) {
  var poolS = data.poolS;
  var poolL = data.poolL;
  var k = data.k;
  var lpS = data.lpS; // 추가된 부분
  var lpL = data.lpL; // 추가된 부분
  console.log(poolS,poolL,k,lpS,lpL);

  var executionAmount;
  var resultMessage = "";

  if (action === "swap") {
    if (swapType === "sl") {
      executionAmount = poolL - (k / (poolS + swapAmount));
      console.log(poolL,k,swapAmount,executionAmount);
      resultMessage = "S-L 스왑 예상값 : 입력하신 " + swapAmount + " S 를 스왑한 " + (executionAmount) + " L 에서 수수료 1 L 을 제외한 " + (executionAmount - 1) + "(실지급 " + (Math.floor(executionAmount) - 1) + ") L 을 지급합니다.";
    } else if (swapType === "ls") {
      executionAmount = poolS - (k / (poolL + swapAmount - 1));
      console.log(poolL,k,swapAmount,executionAmount);
      resultMessage = "L-S 스왑 예상값 : 입력하신 " + swapAmount + " L 에서 수수료 1 L 을 제외한 " + (swapAmount - 1) + " L 을 스왑한 " + executionAmount + " (실지급 " + Math.floor(executionAmount) + ")S 를 지급합니다.";
    }
  } else if (action === "stake") {
    console.log(lpS,lpL,lpAmount);
    resultMessage = "스테이킹 예상값 : 총 " + lpAmount + "개 = [" + Math.ceil(lpS * lpAmount) + "S, " + Math.ceil(lpL * lpAmount) + "L]";
  }
  var expectedOutput = document.getElementById("expectedOutput");
  expectedOutput.innerHTML = "<p>" + resultMessage + "</p>";
}



function executeAction() {
  var action = document.getElementById("action").value;
  var player = document.getElementById("player").value;
  var swapType = document.getElementById("swapType").value;
  var swapAmount = parseInt(document.getElementById("swapAmount").value);

 

  google.script.run.withSuccessHandler(function(data) {
    var poolS = data.poolS;
    var poolL = data.poolL;
    var k = data.k;
    var executionAmount;

    var playerData = data.playerData;
    console.log(poolS,poolL,k,swapType,playerData);

    if (action === "swap") {
      if (swapType === "sl" && swapAmount > playerData[player].S) {
        var resultOutput = document.getElementById("resultOutput");
        resultOutput.innerHTML = "<p>스왑 실패: 입력값을 확인하세요. 보유 S 자산이 부족합니다.</p>";
        return;
      }

      if (swapType === "ls" && swapAmount > playerData[player].L) {
        var resultOutput = document.getElementById("resultOutput");
        resultOutput.innerHTML = "<p>스왑 실패: 입력값을 확인하세요. 보유 L 자산이 부족합니다.</p>";
        return;
      }
      
      if (swapType === "sl") {
        executionAmount = poolL - (k / (poolS + swapAmount));
        poolS += swapAmount;
        poolL -= executionAmount;
        playerData[player].S -= swapAmount;
        playerData[player].L += Math.floor(executionAmount) - 1;
      } else if (swapType === "ls") {
        executionAmount = poolS - (k / (poolL + swapAmount - 1));
        poolL += swapAmount - 1;
        poolS -= executionAmount;
        playerData[player].L -= swapAmount;
        playerData[player].S += Math.floor(executionAmount);
      }

      var resultOutput = document.getElementById("resultOutput");
      resultOutput.innerHTML = "<p>스왑 실행 결과: " + Math.floor(executionAmount) + "</p>";
      console.log(poolS,poolL,playerData);

      // 활동 내역 객체 생성
  var activityLog = {
    player: player,
    action: action,
    swapType: swapType,
    swapAmount: swapAmount,
    executionAmount: executionAmount
  };
console.log(poolS,poolL,playerData,activityLog);
      google.script.run.updateSheetData(poolS, poolL, data.playerData,activityLog); // 수정한 부분
    }
  }).getSheetData(); // 수정한 부분
  console.log(poolS,poolL,playerData,activityLog);
}

// 스프레드시트에서 LP 토큰 수량을 가져오는 함수
  function fetchLPAmounts() {
    google.script.run.withSuccessHandler(function(data) {
      lpS = data.lpS;
      lpL = data.lpL;
    }).getLPAmounts(); // 스프레드시트에서 데이터 가져오기
  }


    function updateSwapFields(action) {
      // 스왑 필드 업데이트 로직
    }

    function updateStakeFields(action) {
      // 스테이킹 필드 업데이트 로직
    }

    // 초기화 코드
document.addEventListener("DOMContentLoaded", function() {
  var actionSelect = document.getElementById("action");

  actionSelect.addEventListener("change", function() {
    var selectedAction = actionSelect.value;
    updateFields(selectedAction); // 이 부분을 추가하여 필드를 업데이트
  });

  updateFields(actionSelect.value);
  // LP 토큰 수량 가져오기
  fetchLPAmounts();
});
  </script>
</body>
</html>
